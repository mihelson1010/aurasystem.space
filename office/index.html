<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aura Office</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ff7700">
  <link rel="icon" href="logo192.png">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:white;
      font-family:Inter, -apple-system, BlinkMacSystemFont, sans-serif;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    .toolbar {
      display:flex;
      justify-content:center;
      padding:14px;
      background:#f9f9f9;
      border-bottom:1px solid #eee;
      gap:12px;
      flex-wrap:wrap;
    }
    .tool-btn {
      padding:10px 20px;
      border-radius:24px;
      font-weight:bold;
      color:white;
      border:none;
      cursor:pointer;
      box-shadow:0 6px 16px rgba(0,0,0,0.1);
    }
    .tool-btn:hover {
      transform:translateY(-2px);
      box-shadow:0 8px 20px rgba(0,0,0,0.15);
    }
    .btn-excel    { background:linear-gradient(135deg, #4a90e2, #50b4ff); }
    .btn-send-txt { background:linear-gradient(135deg, #e74c3c, #f39c12); }
    .btn-send-enc { background:linear-gradient(135deg, #27ae60, #2ecc71); }
    .btn-pdf      { background:linear-gradient(135deg, #9b59b6, #8e44ad); }
    .btn-offline  { background:linear-gradient(135deg, #34495e, #2c3e50); }
    .workspace {
      flex:1;
      padding:20px;
      overflow:auto;
    }
    #editor {
      width:100%;
      min-height:80vh;
      padding:20px;
      font-size:16px;
      line-height:1.6;
      outline:none;
      caret-color:#000;
    }
    #excel-container {
      display:none;
      margin-top:20px;
    }
    .footer {
      position:fixed;
      bottom:12px;
      right:16px;
      font-size:0.8rem;
      color:#888;
    }
  </style>
</head>
<body>

<div class="toolbar">
  <button class="tool-btn btn-excel" onclick="toggleExcel()">üìä Excel</button>
  <button class="tool-btn btn-send-txt" onclick="sendRaw()">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  <button class="tool-btn btn-send-enc" onclick="sendEncrypted()">üîê –ó–∞—à–∏—Ñ—Ä</button>
  <button class="tool-btn btn-pdf" onclick="saveAsPDF()">üìÑ –í PDF</button>
  <button class="tool-btn btn-offline" onclick="showOfflineStatus()">üì¥ Offline</button>
</div>

<div class="workspace">
  <div id="editor" contenteditable="true" spellcheck="false">–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –∑–¥–µ—Å—å...</div>
  <div id="excel-container">
    <p style="padding:20px; color:#666;">Excel-—Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è ‚Äî —á–µ—Ä–µ–∑ Jspreadsheet.</p>
  </div>
</div>

<div class="footer">AURASYSTEM ‚Ä¢ Full control</div>

<!-- –ú–∏–Ω–∏-jsPDF –¥–ª—è PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  let inExcelMode = false;

  function toggleExcel() {
    const editor = document.getElementById('editor');
    const excel = document.getElementById('excel-container');
    if (inExcelMode) {
      editor.style.display = 'block';
      excel.style.display = 'none';
      inExcelMode = false;
    } else {
      editor.style.display = 'none';
      excel.style.display = 'block';
      inExcelMode = true;
    }
  }

  function sendRaw() {
    const text = document.getElementById('editor').innerText.trim();
    if (!text || text === '–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –∑–¥–µ—Å—å...') return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç');
    alert('üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:\n\n' + (text.length > 100 ? text.substring(0,100)+'...' : text));
  }

  async function sendEncrypted() {
    const text = document.getElementById('editor').innerText.trim();
    if (!text || text === '–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –∑–¥–µ—Å—å...') return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç');
    const pass = prompt('üîí –ü–∞—Ä–æ–ª—å –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è (—Å–æ–æ–±—â–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—é):');
    if (!pass) return;
    try {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(pass), "PBKDF2", false, ["deriveKey"]);
      const key = await crypto.subtle.deriveKey({ name:"PBKDF2", salt:enc.encode("AURA"), iterations:100000, hash:"SHA-256" }, keyMaterial, { name:"AES-GCM", length:256 }, false, ["encrypt"]);
      const iv = crypto.getRandomValues(new Uint8Array(12));
      const encrypted = await crypto.subtle.encrypt({ name:"AES-GCM", iv:iv }, key, enc.encode(text));
      const output = btoa(String.fromCharCode(...iv)) + "|" + btoa(String.fromCharCode(...new Uint8Array(encrypted)));
      alert('‚úÖ –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ (E2EE):\n–°–æ–æ–±—â–∏—Ç–µ –ø–∞—Ä–æ–ª—å.\n\n' + output.substring(0, 80) + '...');
    } catch(e) {
      alert('–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è');
    }
  }

  function saveAsPDF() {
    const { jsPDF } = window.jspdf;
    const text = document.getElementById('editor').innerText.trim();
    if (!text || text === '–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –∑–¥–µ—Å—å...') return alert('–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞');
    const doc = new jsPDF();
    doc.text(doc.splitTextToSize(text, 180), 15, 20);
    doc.save("aura_document.pdf");
  }

  function showOfflineStatus() {
    alert(navigator.onLine ? 'üü¢ –û–Ω–ª–∞–π–Ω\n–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.' : '‚ö™ –û—Ñ—Ñ–ª–∞–π–Ω\n–†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.');
  }

  // –ß–µ—Ä–Ω–æ–≤–∏–∫
  window.addEventListener('beforeunload', () => {
    const text = document.getElementById('editor')?.innerText || '';
    if (text && text !== '–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å –∑–¥–µ—Å—å...') {
      localStorage.setItem('aura_office_draft', text);
    }
  });

  window.addEventListener('load', () => {
    const draft = localStorage.getItem('aura_office_draft');
    const editor = document.getElementById('editor');
    if (draft && editor) editor.innerText = draft;
    editor.focus();
  });

  // Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/office/sw.js').catch(console.warn);
    });
  }
</script>

</body>
</html>
