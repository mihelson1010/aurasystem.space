<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aura Office</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{background:#fff;font-family:Inter,sans-serif;min-height:100vh;display:flex;flex-direction:column}.toolbar{display:flex;justify-content:center;padding:14px;background:#f9f9f9;border-bottom:1px solid #eee;gap:8px;flex-wrap:wrap}.tool-btn{padding:10px 16px;border-radius:20px;font-weight:bold;color:#fff;border:none;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.1)}.tool-btn:hover{transform:translateY(-2px);box-shadow:0 6px 14px rgba(0,0,0,.15)}.btn-calc{background:linear-gradient(135deg,#3498db,#2980b6)}.btn-currency{background:linear-gradient(135deg,#ff7700,#ffaa00)}.btn-invite{background:linear-gradient(135deg,#9b59b6,#8e44ad)}.btn-qr{background:linear-gradient(135deg,#2ecc71,#27ae60)}.btn-share{background:linear-gradient(135deg,#e74c3c,#c0392b)}.btn-send-txt{background:linear-gradient(135deg,#1abc9c,#16a085)}.btn-send-enc{background:linear-gradient(135deg,#27ae60,#2ecc71)}.btn-print{background:linear-gradient(135deg,#8e44ad,#9b59b6)}.workspace{flex:1;padding:20px;overflow:auto}#editor{width:100%;min-height:100vh;padding:20px;font-size:16px;line-height:1.6;outline:none;caret-color:#000;background:#fff}.panel{position:fixed;top:80px;left:20px;width:360px;max-height:80vh;overflow-y:auto;background:#0d0d1a;border-radius:16px;padding:20px;box-shadow:0 12px 30px rgba(0,0,0,.4);color:#fff;z-index:100;display:none}.share-links{background:#fff;border:1px solid #ddd;border-radius:16px;padding:20px;text-align:center;margin:20px auto;max-width:400px;box-shadow:0 4px 10px rgba(0,0,0,.1)}.share-links h3{color:#333;margin-bottom:16px}.share-links a{display:inline-block;margin:8px;font-size:28px;text-decoration:none;color:#333}.share-links a:hover{opacity:.8;transform:scale(1.1)}.qr-output{background:#fff;border:1px solid #ddd;border-radius:16px;padding:20px;text-align:center;margin:20px auto;max-width:400px;box-shadow:0 4px 10px rgba(0,0,0,.1)}.qr-output h3{color:#333;margin-bottom:16px}#qrcode canvas{margin:10px auto;display:block;background:#fff;padding:10px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1)}.footer{position:fixed;bottom:12px;right:16px;font-size:.8rem;color:#888}@keyframes blink{0%,100%{opacity:.8}50%{opacity:.4}}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.0/dist/qrious.min.js"></script>
</head>
<body>

<div class="toolbar">
  <button class="tool-btn btn-calc" onclick="showPanel('calc')">üßÆ Calc</button>
  <button class="tool-btn btn-currency" onclick="showPanel('currency'); loadRates()">üí± Forex</button>
  <button class="tool-btn btn-invite" onclick="inviteCollab()">‚úâÔ∏è Invite</button>
  <button class="tool-btn btn-qr" onclick="showQR()">üì± QR</button>
  <button class="tool-btn btn-share" onclick="showShare()">üì§ Share</button>
  <button class="tool-btn btn-send-txt" onclick="sendRaw()">üì§ Send</button>
  <button class="tool-btn btn-send-enc" onclick="sendEncrypted()">üîê Enc</button>
  <button class="tool-btn btn-print" onclick="saveAsPDF()">üñ®Ô∏è Save as PDF</button>
</div>

<div class="workspace">
  <div id="editor" contenteditable="true" spellcheck="false">Start typing here...</div>
  
  <div id="calc" class="panel">
    <div class="calc-container">
      <div class="calc-header">CryptoAura</div>
      <div class="calc-display" id="calc-display">0</div>
      <div class="calc-buttons">
        <button class="calc-btn memory" onclick="calcMR()">MR</button>
        <button class="calc-btn memory" onclick="calcMC()">MC</button>
        <button class="calc-btn gray" onclick="calcClear()">C</button>
        <button class="calc-btn gray" onclick="calcClearEntry()">CE</button>
        <button class="calc-btn gray" onclick="calcInput('7')">7</button>
        <button class="calc-btn gray" onclick="calcInput('8')">8</button>
        <button class="calc-btn gray" onclick="calcInput('9')">9</button>
        <button class="calc-btn orange" onclick="calcInput('/')">/</button>
        <button class="calc-btn gray" onclick="calcInput('4')">4</button>
        <button class="calc-btn gray" onclick="calcInput('5')">5</button>
        <button class="calc-btn gray" onclick="calcInput('6')">6</button>
        <button class="calc-btn orange" onclick="calcInput('*')">*</button>
        <button class="calc-btn gray" onclick="calcInput('1')">1</button>
        <button class="calc-btn gray" onclick="calcInput('2')">2</button>
        <button class="calc-btn gray" onclick="calcInput('3')">3</button>
        <button class="calc-btn orange" onclick="calcInput('-')">-</button>
        <button class="calc-btn gray" onclick="calcInput('0')">0</button>
        <button class="calc-btn gray" onclick="calcInput('.')">.</button>
        <button class="calc-btn green" onclick="calcInput('Math.sqrt(')">‚àö</button>
        <button class="calc-btn orange" onclick="calcInput('+')">+</button>
        <button class="calc-btn memory" onclick="calcMPlus()">M+</button>
        <button class="calc-btn gray" onclick="calcInput('%')">%</button>
        <button class="calc-btn green" onclick="calcEquals()">=</button>
        <button class="calc-btn" style="background:#e74c3c;" onclick="calcBackspace()">‚å´</button>
      </div>
    </div>
  </div>
  
  <div id="currency" class="panel">
    <div class="currency-converter">
      <div class="currency-header">üí± Live Forex</div>
      <div class="currency-input-group">
        <input type="number" id="fromAmount" value="1" oninput="convertFrom()" class="currency-input-field">
        <select id="fromCurrency" onchange="convertFrom()" class="currency-select">
          <optgroup label="Crypto"><option value="BTC">BTC</option><option value="ETH">ETH</option><option value="SOL">SOL</option><option value="XRP">XRP</option><option value="DOGE">DOGE</option><option value="ADA">ADA</option><option value="USDT">USDT</option></optgroup>
          <optgroup label="Fiat"><option value="USD">USD</option><option value="EUR">EUR</option><option value="RUB">RUB</option><option value="CNY">CNY</option><option value="GEL">GEL</option><option value="JPY">JPY</option><option value="ILS">ILS</option><option value="SEK">SEK</option><option value="NOK">NOK</option><option value="DKK">DKK</option><option value="AUD">AUD</option><option value="ARS">ARS</option></optgroup>
        </select>
      </div>
      <div class="currency-swap" onclick="swapCurrencies()">‚Üî</div>
      <div class="currency-input-group">
        <input type="number" id="toAmount" value="" oninput="convertTo()" class="currency-input-field">
        <select id="toCurrency" onchange="convertTo()" class="currency-select">
          <optgroup label="Crypto"><option value="BTC">BTC</option><option value="ETH">ETH</option><option value="SOL">SOL</option><option value="XRP">XRP</option><option value="DOGE">DOGE</option><option value="ADA">ADA</option><option value="USDT">USDT</option></optgroup>
          <optgroup label="Fiat"><option value="USD">USD</option><option value="EUR">EUR</option><option value="RUB">RUB</option><option value="CNY">CNY</option><option value="GEL">GEL</option><option value="JPY">JPY</option><option value="ILS">ILS</option><option value="SEK">SEK</option><option value="NOK">NOK</option><option value="DKK">DKK</option><option value="AUD">AUD</option><option value="ARS">ARS</option></optgroup>
        </select>
      </div>
      <div class="currency-result" id="result">‚Äî</div>
      <div class="currency-rate" id="rate">‚Äî</div>
      <div class="currency-info" id="rate-info">Loading rates...</div>
    </div>
  </div>
  
  <div id="qr" class="panel">
    <div class="qr-output">
      <h3>üì± QR Code</h3>
      <div id="qrcode"></div>
      <p>Scan to share your document</p>
    </div>
  </div>
  
  <div id="share" class="panel">
    <div class="share-links" id="share-links">
      <h3>üì§ Share</h3>
      <div id="share-buttons"></div>
    </div>
  </div>
</div>

<div class="footer">AURASYSTEM ‚Ä¢ Full control</div>

<script>
// === –ö–ê–õ–¨–ö–£–õ–Ø–¢–û–†, –í–ê–õ–Æ–¢–´, QR, SHARE ‚Äî –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ===
let calcMemory = 0;
let calcExpression = '';

function calcInput(value) {
  if (value === 'Math.sqrt(') {
    calcExpression += 'Math.sqrt(';
  } else {
    calcExpression += value;
  }
  updateCalcDisplay();
}

function calcEquals() {
  try {
    let expr = calcExpression.replace(/(\d+)%/g, '($1/100)');
    let result = eval(expr);
    calcExpression = String(result);
  } catch (e) {
    calcExpression = 'Error';
  }
  updateCalcDisplay();
}

function calcClear() {
  calcExpression = '';
  updateCalcDisplay();
}

function calcClearEntry() {
  if (calcExpression.length > 0) {
    calcExpression = calcExpression.slice(0, -1);
  }
  updateCalcDisplay();
}

function calcBackspace() {
  calcClearEntry();
}

function calcMPlus() {
  try {
    calcMemory += parseFloat(eval(calcExpression || '0'));
  } catch (e) {}
}

function calcMR() {
  calcExpression = String(calcMemory);
  updateCalcDisplay();
}

function calcMC() {
  calcMemory = 0;
}

function updateCalcDisplay() {
  const display = document.getElementById('calc-display');
  if (calcExpression === '') {
    display.textContent = '0';
  } else if (calcExpression.length > 15) {
    display.textContent = calcExpression.slice(0, 15) + '...';
  } else {
    display.textContent = calcExpression;
  }
}

let rates = null;
const STATIC_RATES_USD = {
  USD: 1, EUR: 0.93, RUB: 93.5, CNY: 7.25, GEL: 2.70, JPY: 155.0,
  ILS: 3.70, SEK: 10.50, NOK: 10.80, DKK: 6.90, AUD: 1.52, ARS: 950.0,
  BTC: 1/92410, ETH: 1/2870, SOL: 1/172, XRP: 1/0.58,
  DOGE: 1/0.172, ADA: 1/0.45, USDT: 1/1.0001
};
let isConverting = false;

async function loadRates() {
  if (rates) return;
  try {
    const res = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum,solana,ripple,dogecoin,cardano,tether&vs_currencies=usd,eur,rub,cny,gel,jpy,ils,sek,nok,dkk,aud,ars');
    const data = await res.json();
    rates = {
      BTC: { usd: data.bitcoin.usd, eur: data.bitcoin.eur, rub: data.bitcoin.rub },
      ETH: { usd: data.ethereum.usd, eur: data.ethereum.eur, rub: data.ethereum.rub },
    };
    document.getElementById('rate-info').textContent = '‚úÖ Online rates';
    convertFrom();
  } catch (e) {
    rates = null;
    document.getElementById('rate-info').textContent = '‚ö†Ô∏è Offline (static rates)';
    convertFrom();
  }
}

function getUSDPrice(currency, amount = 1) {
  if (currency === 'USD') return amount;
  if (rates) {
    const id = currency.toLowerCase();
    if (rates[id]) {
      return amount * rates[id].usd;
    }
  }
  return amount / STATIC_RATES_USD[currency];
}

function convertFrom() {
  if (isConverting) return;
  isConverting = true;
  const from = document.getElementById('fromCurrency').value;
  const to = document.getElementById('toCurrency').value;
  const fromAmount = parseFloat(document.getElementById('fromAmount').value) || 0;
  
  if (from === to) {
    const v = fromAmount;
    document.getElementById('toAmount').value = v;
    document.getElementById('result').textContent = `${fromAmount} ${from} = ${v} ${to}`;
    document.getElementById('rate').textContent = '';
  } else {
    const usd = getUSDPrice(from, fromAmount);
    const toAmount = usd / getUSDPrice(to, 1);
    document.getElementById('toAmount').value = toAmount.toFixed(6);
    document.getElementById('result').textContent = `${fromAmount} ${from} = ${toAmount.toFixed(6)} ${to}`;
    document.getElementById('rate').textContent = `1 ${from} = ${(toAmount / fromAmount).toFixed(6)} ${to}`;
  }
  isConverting = false;
}

function convertTo() {
  if (isConverting) return;
  isConverting = true;
  const from = document.getElementById('fromCurrency').value;
  const to = document.getElementById('toCurrency').value;
  const toAmount = parseFloat(document.getElementById('toAmount').value) || 0;
  
  if (from === to) {
    document.getElementById('fromAmount').value = toAmount;
    document.getElementById('result').textContent = `${toAmount} ${to} = ${toAmount} ${from}`;
    document.getElementById('rate').textContent = '';
  } else {
    const usd = getUSDPrice(to, toAmount);
    const fromAmount = usd / getUSDPrice(from, 1);
    document.getElementById('fromAmount').value = fromAmount.toFixed(6);
    document.getElementById('result').textContent = `${fromAmount.toFixed(6)} ${from} = ${toAmount} ${to}`;
    document.getElementById('rate').textContent = `1 ${to} = ${(fromAmount / toAmount).toFixed(6)} ${from}`;
  }
  isConverting = false;
}

function swapCurrencies() {
  const fromSel = document.getElementById('fromCurrency');
  const toSel = document.getElementById('toCurrency');
  const fromVal = fromSel.value;
  const fromAmt = document.getElementById('fromAmount').value;
  
  fromSel.value = toSel.value;
  toSel.value = fromVal;
  
  document.getElementById('fromAmount').value = document.getElementById('toAmount').value;
  document.getElementById('toAmount').value = fromAmt;
  
  convertFrom();
}

function generateQR() {
  const text = document.getElementById('editor').innerText.trim() || 'Document from Aura Office';
  const qrContainer = document.getElementById('qrcode');
  qrContainer.innerHTML = '';
  const qr = new QRious({
    element: document.createElement('canvas'),
    value: text,
    size: 20, /* fix for CSP */
  });
  // Increase QR size properly
  qr.set({ size: 200 });
  qrContainer.appendChild(qr.element);
}

function showShare() {
  const url = 'https://aurasystem.space/office/';
  const text = 'Document from Aura Office';
  const buttons = `
    <a href="https://x.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}" target="_blank" style="color:#000;">ùïè</a>
    <a href="https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}" target="_blank" style="color:#0088cc;">Telegram</a>
    <a href="https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}" target="_blank" style="color:#25d366;">WhatsApp</a>
    <a href="mailto:?subject=${encodeURIComponent(text)}&body=${encodeURIComponent(url)}" style="color:#ff6b6b;">Email</a>
  `;
  document.getElementById('share-buttons').innerHTML = buttons;
}

function showQR() {
  const qr = document.getElementById('qr');
  qr.style.display = 'block';
  generateQR();
}

function showShare() {
  const share = document.getElementById('share');
  share.style.display = 'block';
  showShare();
}

function showPanel(id) {
  document.querySelectorAll('.panel').forEach(p => p.style.display = 'none');
  document.getElementById(id).style.display = 'block';
  if (id === 'qr') generateQR();
  if (id === 'share') showShare();
}

// === E2EE FUNCTIONS ===
async function encryptTextAES(text, password) {
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw',
    enc.encode(password),
    { name: 'PBKDF2' },
    false,
    ['deriveKey']
  );
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const key = await crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    false,
    ['encrypt']
  );
  const nonce = crypto.getRandomValues(new Uint8Array(12));
  const encrypted = await crypto.subtle.encrypt(
    { name: 'AES-GCM', iv: nonce },
    key,
    enc.encode(text)
  );
  const payload = new Uint8Array(salt.length + nonce.length + encrypted.byteLength);
  payload.set(salt, 0);
  payload.set(nonce, salt.length);
  payload.set(new Uint8Array(encrypted), salt.length + nonce.length);
  return btoa(String.fromCharCode(...payload));
}

async function decryptTextAES(payloadB64, password) {
  const payload = new Uint8Array(atob(payloadB64).split('').map(c => c.charCodeAt(0)));
  const salt = payload.slice(0, 16);
  const nonce = payload.slice(16, 28);
  const encrypted = payload.slice(28);
  const enc = new TextEncoder();
  const keyMaterial = await crypto.subtle.importKey(
    'raw',
    enc.encode(password),
    { name: 'PBKDF2' },
    false,
    ['deriveKey']
  );
  const key = await crypto.subtle.deriveKey(
    { name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' },
    keyMaterial,
    { name: 'AES-GCM', length: 256 },
    false,
    ['decrypt']
  );
  const decrypted = await crypto.subtle.decrypt(
    { name: 'AES-GCM', iv: nonce },
    key,
    encrypted
  );
  return new TextDecoder().decode(decrypted);
}

// === SEND FUNCTIONS ===
function sendRaw() {
  const id = 'AURA-' + Math.random().toString(36).substr(2, 5).toUpperCase();
  localStorage.setItem('doc_' + id, document.getElementById('editor').innerText);
  const url = 'https://aurasystem.space/office/?doc=' + id;
  prompt('Send this link (unencrypted):', url);
}

async function sendEncrypted() {
  const text = document.getElementById('editor').innerText;
  const password = prompt('Enter a password for encryption (share it separately!):');
  if (!password || !text.trim()) return;
  try {
    const payload = await encryptTextAES(text, password);
    const url = location.origin + location.pathname + '#doc=' + payload;
    prompt('Send this link (encrypted):', url);
  } catch (e) {
    alert('Encryption failed');
  }
}

// === LOAD DOCUMENT ON START ===
window.addEventListener('load', async () => {
  const editor = document.getElementById('editor');
  editor.focus();

  // –ù–µ–∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ ?doc=ID
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('doc')) {
    const id = urlParams.get('doc');
    const saved = localStorage.getItem('doc_' + id);
    if (saved) editor.innerText = saved;
  }

  // –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ #doc=...
  if (window.location.hash.startsWith('#doc=')) {
    const payload = window.location.hash.slice(5);
    const password = prompt('Enter password to decrypt document:');
    if (password) {
      try {
        const text = await decryptTextAES(payload, password);
        editor.innerText = text;
      } catch (e) {
        alert('‚ùå Decryption failed. Wrong password or corrupted data.');
      }
    }
  }

  loadRates();
});

function inviteCollab() {
  sendRaw(); // reuse sendRaw logic
}

function saveAsPDF() {
  const element = document.getElementById('editor');
  const opt = {
    margin: 10,
    filename: 'aurasystem_document.pdf',
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(element).save();
}
</script>
</body>
</html>
